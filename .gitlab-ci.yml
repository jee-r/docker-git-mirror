variables:
  ARTIFACT_DIR: "./archive" # must be relative to the build directory - https://gitlab.com/gitlab-org/gitlab-foss/-/issues/15530
  ARTIFACT_NAME: "${CI_PROJECT_NAME}-build.tar"
  STORAGE_DRIVER: "vfs"
  BUILDAH_FORMAT: "docker"
  TAG: "${CI_COMMIT_BRANCH}"

stages:
  - build
  - push

workflow:
  rules:
    - if: $CI_COMMIT_BRANCH == "master"
      variables:
        TAG: "latest" 

build:
  stage: "build"
  image:
    name: "quay.io/buildah/stable:latest"
  script:
    - "echo ${TAG}"
    - "buildah build -f Dockerfile -t ${CI_REGISTRY_IMAGE}:${CI_COMMIT_SHA} ."
    - "mkdir ${ARTIFACT_DIR}"
    - "buildah push ${CI_REGISTRY_IMAGE}:${CI_COMMIT_SHA} docker-archive:${ARTIFACT_DIR}/${ARTIFACT_NAME}:${CI_COMMIT_SHA}"
  artifacts:
    name: "archive:${ARTIFACT_NAME}:${CI_JOB_ID}"
    when: "on_success"
    expire_in: "6h"
    paths:
      - "${ARTIFACT_DIR}/"

push:
  stage: "push"
  image:
    name: "quay.io/buildah/stable:v1.21.0"
  only:
    - "tags"
    - "main"
    - "master"
    - "dev"
  script:
    - "buildah pull docker-archive:${ARTIFACT_DIR}/${ARTIFACT_NAME}"
    - "echo $CI_REGISTRY_PASSWORD | buildah login -u $CI_REGISTRY_USER --password-stdin $CI_REGISTRY"
    - "buildah tag ${CI_REGISTRY_IMAGE}:${CI_COMMIT_SHA} ${CI_REGISTRY_IMAGE}:${CI_COMMIT_BRANCH} ${CI_REGISTRY_IMAGE}:${TAG}"
    - "buildah push ${CI_REGISTRY_IMAGE}:${CI_COMMIT_BRANCH}"
    - "buildah push ${CI_REGISTRY_IMAGE}:${CI_COMMIT_SHA}"
    - "buildah push ${CI_REGISTRY_IMAGE}:${TAG}"
  dependencies:
    - "build"
